<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAGIS Tube Ultimate - Jorge</title>
    
    <!-- Librer√≠as Externas (CDNs) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Cinzel:wght@700&display=swap" rel="stylesheet">

    <style>
        /* Estilos Base */
        body { background-color: #111827; color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        /* Scrollbars */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animaciones */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes heartPop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        
        /* Animaci√≥n de Nieve */
        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 0.8; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0.2; }
        }

        .animate-fade-in { animation: fadeIn 0.6s ease-out; }
        .animate-slide-up { animation: slideUp 0.8s ease-out; }
        .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }
        .heart-pop { animation: heartPop 0.3s ease-in-out; }
        
        .text-gold-gradient {
            background: linear-gradient(to right, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Utilidad para m√≥viles (Safe Area) */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Estilo para iframe responsive (Google Drive) */
        .iframe-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; background: black; }
        .iframe-container iframe { width: 100%; height: 100%; border: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONFIGURACI√ìN DE URLS ---
        const URLS = {
            TV: 'https://raw.githubusercontent.com/sejo48/retrom3u/refs/heads/main/listaoficial.m3u',
            SERIES: 'https://raw.githubusercontent.com/sejo48/jorgedrive/refs/heads/main/playlist.json',
            MOVIES: 'https://raw.githubusercontent.com/sejo48/peliculas/refs/heads/main/peliculas.json'
        };

        // --- COMPONENTE DE ICONOS ---
        const Icon = ({ name, size = 24, className, fill = "none" }) => {
            const icons = {
                search: <path d="M21 21l-4.35-4.35m0 0a7.5 7.5 0 111.414-1.414 7.5 7.5 0 01-1.414 1.414z" />,
                menu: <path d="M4 6h16M4 12h16M4 18h16" />,
                x: <path d="M6 18L18 6M6 6l12 12" />,
                tv: <path d="M6 20.25h12m-7.5-3v3m3-3v3m-10.125-3h17.25c.621 0 1.125-.504 1.125-1.125V4.875c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125z" />,
                film: <path d="M19.82 2H4.18C2.97 2 2 2.97 2 4.18v15.64C2 21.03 2.97 22 4.18 22h15.64c1.21 0 2.18-.97 2.18-2.18V4.18C22 2.97 21.03 2 19.82 2zM7 2v20M17 2v20M2 12h20M2 7h5M2 17h5M17 7h5M17 17h5" />,
                play: <path d="M5 3l14 9-14 9V3z" />,
                heart: <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z" />,
                arrowLeft: <path d="M19 12H5m7 7l-7-7 7-7" />,
                alertCircle: <><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></>,
                chevronDown: <path d="M6 9l6 6 6-6" />,
                chevronUp: <path d="M18 15l-6-6-6 6" />,
                clapperboard: <><path d="M20.2 6 3 11l-.9-2.4c-.5-1.1.2-2.3 1.3-2.8l3.2-1.4c1.1-.5 2.3.2 2.8 1.3l.9 2.4l7.9-3l2 4.5Z"/><path d="M4 11v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-9"/></>,
                external: <><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></>,
                lock: <path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a7 7 0 00-14 0v2" />
            };
            
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill={fill} 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                >
                    {icons[name] || icons.search}
                </svg>
            );
        };

        // --- COMPONENTE DE NIEVE ---
        const Snow = () => {
            const flakes = useMemo(() => Array.from({ length: 40 }).map((_, i) => ({
                id: i,
                left: Math.random() * 100 + 'vw',
                animationDuration: (Math.random() * 5 + 5) + 's',
                animationDelay: (Math.random() * 5) + 's',
                opacity: Math.random() * 0.5 + 0.3,
                fontSize: (Math.random() * 10 + 10) + 'px'
            })), []);

            return (
                <div className="fixed inset-0 pointer-events-none z-[60] overflow-hidden">
                    {flakes.map(flake => (
                        <div 
                            key={flake.id} 
                            className="absolute top-[-20px] text-white select-none" 
                            style={{
                                left: flake.left,
                                animation: `fall ${flake.animationDuration} linear infinite`,
                                animationDelay: flake.animationDelay,
                                opacity: flake.opacity,
                                fontSize: flake.fontSize,
                            }}
                        >
                            ‚ùÑ
                        </div>
                    ))}
                </div>
            );
        };

        // --- PANTALLA DE BLOQUEO ---
        const LockScreen = ({ onUnlock, correctCode, onCancel }) => {
            const [input, setInput] = useState('');
            const [error, setError] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (input === String(correctCode)) {
                    onUnlock();
                } else {
                    setError(true);
                    setInput('');
                }
            };

            return (
                <div className="absolute inset-0 z-50 bg-black/95 backdrop-blur-sm flex flex-col items-center justify-center p-4 animate-fade-in">
                    <div className="bg-[#1f2937] p-8 rounded-xl max-w-xs w-full text-center border border-white/10 shadow-2xl">
                        <div className="mb-6 flex justify-center">
                            <div className="p-4 bg-red-500/20 rounded-full text-red-500 border border-red-500/30 shadow-[0_0_15px_rgba(239,68,68,0.4)]">
                                <Icon name="lock" size={32} />
                            </div>
                        </div>
                        <h2 className="text-xl font-bold text-white mb-2">Contenido Protegido</h2>
                        <p className="text-gray-400 text-xs mb-6">Introduce el c√≥digo de acceso de 4 d√≠gitos para ver este contenido.</p>
                        
                        <form onSubmit={handleSubmit}>
                            <input 
                                type="password" 
                                maxLength="4"
                                className="w-full bg-black/50 border border-white/20 rounded-lg px-4 py-3 text-center text-2xl tracking-[0.5em] text-white focus:border-[#E50914] outline-none mb-4 transition-colors placeholder-gray-600"
                                value={input}
                                onChange={(e) => { setInput(e.target.value); setError(false); }}
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                autoFocus
                            />
                            {error && <p className="text-red-500 text-xs mb-4 font-bold animate-shake">C√≥digo incorrecto</p>}
                            
                            <div className="flex gap-3">
                                <button type="button" onClick={onCancel} className="flex-1 py-2 rounded-lg border border-white/10 text-gray-300 hover:bg-white/5 transition-colors text-sm">
                                    Cancelar
                                </button>
                                <button type="submit" className="flex-1 py-2 rounded-lg bg-[#E50914] text-white font-bold hover:bg-red-700 transition-colors text-sm shadow-lg shadow-red-900/20">
                                    Acceder
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- PANTALLA INTRO ---
        const IntroScreen = ({ onEnter }) => (
            <div className="fixed inset-0 z-[100] bg-[#111827] flex items-center justify-center overflow-hidden font-sans">
                <Snow />
                <div className="absolute inset-0">
                    <img src="https://images.unsplash.com/photo-1574375927938-d5a98e8ffe85?q=80&w=2069&auto=format&fit=crop" className="w-full h-full object-cover opacity-10 animate-pulse" alt="Background"/>
                    <div className="absolute inset-0 bg-gradient-to-b from-[#111827] via-[#111827]/90 to-[#111827]"></div>
                </div>
                <div className="relative z-10 text-center p-6 max-w-3xl animate-slide-up">
                    <div className="mb-4 inline-block bg-[#E50914] px-3 py-1 rounded text-xs font-bold tracking-widest uppercase text-white shadow-[0_0_15px_rgba(229,9,20,0.5)]">Premium Access</div>
                    <h1 className="text-6xl md:text-8xl font-black text-white mb-2 tracking-tighter drop-shadow-2xl">
                        MAGIS<span className="text-[#E50914]">Tube</span>
                    </h1>
                    <p className="text-xl md:text-2xl text-gray-400 font-light mb-8 italic">"Donde la nostalgia se encuentra con la tecnolog√≠a."</p>
                    <div className="h-px w-32 bg-gradient-to-r from-transparent via-[#E50914] to-transparent mx-auto mb-8 opacity-50"></div>
                    <p className="text-sm md:text-lg text-white font-medium mb-10 max-w-2xl mx-auto leading-relaxed drop-shadow-lg text-center">
                        Accede al instante a la mejor colecci√≥n de series cl√°sicas, cine de culto y televisi√≥n en vivo. Sin suscripciones, sin l√≠mites. Tu universo de entretenimiento personal.
                    </p>
                    <button onClick={onEnter} className="group relative bg-white text-black px-10 py-4 rounded-full font-bold text-lg hover:scale-105 transition-all duration-300 shadow-[0_0_20px_rgba(255,255,255,0.2)] flex items-center gap-2 mx-auto">
                        <span>Comenzar a Ver</span> <Icon name="play" size={20} fill="black" />
                    </button>
                    <div className="mt-16 opacity-80">
                        <p className="text-[10px] text-gray-500 uppercase tracking-widest mb-1">DISE√ëADO Y PROGRAMADO POR</p>
                        <h3 className="text-xl font-serif text-gold-gradient font-bold mb-2">JORGE ARTURO HERN√ÅNDEZ M√âNDEZ</h3>
                        <p className="text-[10px] text-gray-600">Potenciado por la inteligencia de <span className="text-blue-400">Gemini AI</span></p>
                    </div>
                </div>
            </div>
        );

        // --- HERO SECTION ---
        const HeroSection = ({ item, onPlay, isFavorite, onToggleFavorite }) => {
            if (!item) return null;
            return (
                <div className="relative w-full h-[50vh] md:h-[65vh] overflow-hidden mb-8 group animate-fade-in">
                    <div className="absolute inset-0">
                        <img 
                            src={item.image || item.poster} 
                            alt="Hero" 
                            className="w-full h-full object-cover opacity-60"
                            onError={(e) => e.target.src = 'https://placehold.co/1920x1080/111827/ffffff?text=StreamTube'}
                        />
                        <div className="absolute inset-0 bg-gradient-to-t from-[#111827] via-[#111827]/40 to-transparent"></div>
                        <div className="absolute inset-0 bg-gradient-to-r from-[#111827] via-[#111827]/60 to-transparent"></div>
                    </div>
                    <div className="absolute inset-0 flex items-center p-6 md:p-12 max-w-7xl mx-auto">
                        <div className="flex flex-col md:flex-row gap-8 items-center md:items-end w-full">
                            <div className="hidden md:block w-48 lg:w-64 flex-shrink-0 rounded-lg shadow-2xl overflow-hidden border border-white/10 transform -rotate-2 hover:rotate-0 transition-all duration-500">
                                <img src={item.image || item.poster} className="w-full h-full object-cover" />
                            </div>
                            <div className="flex flex-col gap-4 items-start flex-1">
                                <span className="bg-[#E50914] text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-widest">
                                    {item.type === 'tv' ? 'En Vivo' : item.type === 'series' ? 'Serie Destacada' : 'Pel√≠cula'}
                                </span>
                                <h1 className="text-4xl md:text-6xl font-black text-white leading-tight drop-shadow-xl line-clamp-2">
                                    {item.title || item.name}
                                </h1>
                                <p className="text-gray-300 text-sm md:text-base max-w-xl line-clamp-3">
                                    {item.description || item.plot || "Disfruta del mejor contenido seleccionado especialmente para ti. Disponible ahora en alta definici√≥n."}
                                </p>
                                <div className="flex gap-4 mt-4">
                                    <button onClick={() => onPlay(item)} className="bg-white text-black px-8 py-3 rounded-lg font-bold flex items-center gap-2 hover:bg-gray-200 transition-transform hover:scale-105">
                                        <Icon name="play" size={20} fill="black"/> Reproducir
                                    </button>
                                    <button onClick={() => onToggleFavorite(item)} className="bg-white/10 text-white px-4 py-3 rounded-lg font-bold flex items-center gap-2 hover:bg-white/20 backdrop-blur-sm border border-white/10">
                                        <Icon name="heart" size={20} className={isFavorite ? "text-[#E50914] fill-[#E50914] heart-pop" : "text-white"} fill={isFavorite ? "#E50914" : "none"} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- ELEMENTO DE LISTA TV CON FAVORITO ---
        const TvListItem = ({ channel, isActive, onClick, isFavorite, onToggleFavorite }) => (
            <div 
                onClick={() => onClick(channel)}
                className={`group flex items-center gap-3 p-3 border-b border-white/5 cursor-pointer transition-colors ${isActive ? 'bg-[#1f2937] border-l-4 border-l-[#E50914]' : 'hover:bg-white/5'}`}
            >
                <div className="w-12 h-8 rounded bg-black flex items-center justify-center overflow-hidden flex-shrink-0 border border-white/10">
                    {channel.image ? (
                        <img src={channel.image} alt={channel.title} className="w-full h-full object-contain" onError={(e) => e.target.style.display='none'} />
                    ) : (
                        <Icon name="tv" size={16} className="opacity-50 text-gray-400"/>
                    )}
                </div>
                <div className="flex-1 min-w-0">
                    <p className={`text-sm font-medium truncate ${isActive ? 'text-[#E50914]' : 'text-white'}`}>{channel.title}</p>
                    <p className="text-xs text-gray-500 truncate">{channel.group || 'General'}</p>
                </div>

                {/* Bot√≥n Favorito en Lista */}
                <button 
                    onClick={(e) => { e.stopPropagation(); onToggleFavorite(channel); }}
                    className="p-2 rounded-full hover:bg-white/10 text-gray-500 hover:text-white z-10"
                >
                    <Icon 
                        name="heart"
                        size={18} 
                        className={isFavorite ? "text-[#E50914] fill-[#E50914] heart-pop" : ""} 
                        fill={isFavorite ? "#E50914" : "none"}
                    />
                </button>

                {isActive && <div className="w-2 h-2 bg-[#E50914] rounded-full animate-pulse ml-1"></div>}
            </div>
        );

        // --- TARJETAS (CARDS) ---
        const Card = ({ item, onClick, isFavorite, onToggleFavorite }) => {
            const isTv = item.type === 'tv';
            // Detectar si tiene c√≥digo
            const hasLock = item.codigo || item.password || item.pin || item.clave;

            return (
                <div className="group relative flex flex-col gap-2 min-w-[140px] cursor-pointer" onClick={() => onClick(item)}>
                    <div className={`relative overflow-hidden rounded-lg bg-[#1f2937] shadow-lg transition-all duration-300 group-hover:shadow-[#E50914]/20 border border-transparent group-hover:border-white/10 ${isTv ? 'aspect-video' : 'aspect-[2/3]'}`}>
                        <img 
                            src={item.image || item.poster || item.logo} 
                            className={`w-full h-full ${isTv ? 'object-contain p-4' : 'object-cover'} transition-transform duration-500 group-hover:scale-110`}
                            onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/300x450/1f2937/ffffff?text=${(item.title || item.name || 'X').charAt(0)}`; }}
                            alt={item.title || item.name}
                        />
                        <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <div className="bg-[#E50914] p-3 rounded-full shadow-lg transform scale-0 group-hover:scale-100 transition-transform duration-300">
                                {hasLock ? <Icon name="lock" size={24} className="text-white"/> : <Icon name="play" size={24} fill="white" className="text-white ml-1" />}
                            </div>
                        </div>
                        <button 
                            onClick={(e) => { e.stopPropagation(); onToggleFavorite(item); }}
                            className="absolute top-2 right-2 p-1.5 bg-black/50 rounded-full hover:bg-black/80 transition-colors opacity-0 group-hover:opacity-100"
                        >
                            <Icon name="heart" size={16} className={isFavorite ? "text-[#E50914] fill-[#E50914]" : "text-white"} fill={isFavorite ? "#E50914" : "none"} />
                        </button>
                        
                        {/* Indicadores en tarjeta */}
                        <div className="absolute bottom-2 left-2 flex gap-1">
                            {isTv && <span className="bg-[#E50914] text-white text-[9px] font-bold px-1.5 py-0.5 rounded shadow-sm">LIVE</span>}
                            {hasLock && <span className="bg-yellow-500 text-black text-[9px] font-bold px-1.5 py-0.5 rounded flex items-center gap-0.5 shadow-sm"><Icon name="lock" size={8}/> PIN</span>}
                        </div>
                    </div>
                    <h3 className="text-sm font-bold text-gray-200 truncate group-hover:text-white transition-colors">{item.title || item.name}</h3>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [showIntro, setShowIntro] = useState(true);
            const [activeTab, setActiveTab] = useState('home');
            const [content, setContent] = useState({ tv: [], series: [], movies: [] });
            const [search, setSearch] = useState('');
            
            // ESTADOS DE REPRODUCCI√ìN Y BLOQUEO
            const [selectedItem, setSelectedItem] = useState(null);
            const [selectedEpisode, setSelectedEpisode] = useState(null);
            const [isLocked, setIsLocked] = useState(false); 
            
            const [favorites, setFavorites] = useState([]);
            const [loading, setLoading] = useState(true);
            const [expandedSeason, setExpandedSeason] = useState(0);

            const videoRef = useRef(null);
            const hlsRef = useRef(null);

            // --- UTILIDAD PARA LIMPIAR URLS DE DRIVE ---
            const cleanDriveUrl = (url) => {
                if (!url) return '';
                if (url.includes('drive.google.com')) {
                    if (url.includes('/preview')) return url;
                    const match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
                    return match ? `https://drive.google.com/file/d/${match[1]}/preview` : url;
                }
                return url;
            };

            // CARGAR DATOS
            useEffect(() => {
                const fetchData = async () => {
                    try {
                        setLoading(true);
                        
                        // TV
                        const resTV = await fetch(URLS.TV);
                        const textTV = await resTV.text();
                        const tvChannels = parseM3U(textTV);

                        // Series
                        const resSeries = await fetch(URLS.SERIES);
                        const jsonSeries = await resSeries.json();
                        const rawSeries = Array.isArray(jsonSeries) ? jsonSeries : [];
                        
                        const seriesList = rawSeries.map(s => ({
                            id: s.tituloSerie, 
                            title: s.tituloSerie || s.name || s.title,
                            description: s.descripcion || s.description,
                            image: s.imagen || s.image || s.poster,
                            type: 'series',
                            // Preservar el c√≥digo de bloqueo si existe
                            codigo: s.codigo || s.password || s.pin || s.clave,
                            seasons: (s.temporadas || []).map(t => ({
                                season_number: t.numeroTemporada || 1,
                                episodes: (t.episodios || []).map(e => ({
                                    title: e.tituloEpisodio || e.title || e.name,
                                    url: cleanDriveUrl(e.urlDrive || e.url || e.video || e.link || e.enlace),
                                    image: s.imagen 
                                }))
                            }))
                        }));

                        // Pel√≠culas
                        const resMovies = await fetch(URLS.MOVIES);
                        const jsonMovies = await resMovies.json();
                        const rawMovies = Array.isArray(jsonMovies) ? jsonMovies : (jsonMovies.peliculas || []);
                        
                        const moviesList = rawMovies.map(m => ({
                            ...m,
                            type: 'movie',
                            title: m.titulo || m.title,
                            image: m.imagen || m.poster,
                            // Preservar el c√≥digo de bloqueo si existe
                            codigo: m.codigo || m.password || m.pin || m.clave,
                            url: cleanDriveUrl(m.urlDrive || m.url || m.video || m.enlace || m.link)
                        }));

                        setContent({ 
                            tv: tvChannels, 
                            series: seriesList, 
                            movies: moviesList
                        });

                    } catch (err) {
                        console.error("Error cargando datos", err);
                    } finally {
                        setLoading(false);
                    }
                };

                const storedFavs = localStorage.getItem('magistube_favs');
                if (storedFavs) setFavorites(JSON.parse(storedFavs));

                fetchData();
            }, []);

            const parseM3U = (data) => {
                const lines = data.split('\n');
                const channels = [];
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].trim().startsWith('#EXTINF:')) {
                        const url = lines[i + 1]?.trim();
                        if (url && url.startsWith('http')) {
                            const info = lines[i];
                            const title = info.split(',')[1]?.trim() || 'Canal';
                            const logo = info.match(/tvg-logo="([^"]*)"/)?.[1];
                            const group = info.match(/group-title="([^"]*)"/)?.[1] || 'General';
                            channels.push({ id: `tv-${i}`, title, image: logo, group, url, type: 'tv' });
                        }
                    }
                }
                return channels;
            };

            // --- LOGICA DE REPRODUCTOR ---
            const getPlayUrl = () => {
                if (selectedItem?.type === 'tv' || selectedItem?.type === 'movie') {
                     return selectedItem.url;
                } else if (selectedItem?.type === 'series' && selectedEpisode) {
                     return selectedEpisode.url;
                }
                return '';
            };

            const playUrl = getPlayUrl();
            const isDriveLink = playUrl && playUrl.includes('drive.google.com');

            useEffect(() => {
                // Si est√° bloqueado, no intentamos reproducir nada
                if (isLocked) return;

                if (isDriveLink) {
                    if (hlsRef.current) { hlsRef.current.destroy(); hlsRef.current = null; }
                    return;
                }

                if (!playUrl || !videoRef.current) return;

                const video = videoRef.current;
                if (hlsRef.current) { hlsRef.current.destroy(); hlsRef.current = null; }

                if (Hls.isSupported() && (playUrl.includes('.m3u8') || selectedItem?.type === 'tv')) {
                    const hls = new Hls();
                    hlsRef.current = hls;
                    hls.loadSource(playUrl);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(() => {}));
                } else {
                    video.src = playUrl;
                    video.load();
                    video.play().catch(() => {});
                }
            }, [playUrl, isDriveLink, selectedItem, isLocked]);

            // FUNCIONES
            const toggleFavorite = (item) => {
                let newFavs;
                const itemId = item.id || item.title;
                if (favorites.some(f => (f.id || f.title) === itemId)) {
                    newFavs = favorites.filter(f => (f.id || f.title) !== itemId);
                } else {
                    newFavs = [item, ...favorites];
                }
                setFavorites(newFavs);
                localStorage.setItem('magistube_favs', JSON.stringify(newFavs));
            };

            const handlePlay = (item) => {
                // Comprobar bloqueo
                const code = item.codigo || item.password || item.pin || item.clave;
                
                if (code) {
                    setSelectedItem(item); 
                    setIsLocked(true);
                } else {
                    setSelectedItem(item);
                    setIsLocked(false);
                }

                setExpandedSeason(0); 
                
                if (item.type === 'series') {
                    const seasons = item.seasons || [];
                    const firstSeason = seasons[0];
                    if (firstSeason) {
                        const episodes = firstSeason.episodes || [];
                        const firstEp = episodes[0];
                        if (firstEp) {
                            setSelectedEpisode({
                                title: firstEp.title,
                                url: firstEp.url,
                                image: firstEp.image
                            });
                        } else {
                            setSelectedEpisode(null);
                        }
                    }
                }
                
                // Scroll logic: Only scroll to top automatically if it's NOT TV, or if it IS TV but we're on mobile
                if (item.type !== 'tv' || window.innerWidth < 1024) {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            const getDisplayContent = () => {
                let list = [];
                if (activeTab === 'home') list = [...content.movies.slice(0,20), ...content.series.slice(0,20), ...content.tv.slice(0,20)]; 
                else if (activeTab === 'favorites') list = favorites;
                else list = content[activeTab] || [];

                if (search) return list.filter(i => (i.title || i.name).toLowerCase().includes(search.toLowerCase()));
                return list;
            };

            const displayedItems = getDisplayContent();
            const heroItem = useMemo(() => {
                if (content.movies.length > 0) return content.movies[Math.floor(Math.random() * content.movies.length)];
                if (content.series.length > 0) return content.series[0];
                return null;
            }, [content]);

            if (showIntro) return <IntroScreen onEnter={() => setShowIntro(false)} />;

            return (
                <div className="min-h-screen bg-[#111827] text-white font-sans flex flex-col md:flex-row relative">
                    
                    {/* SIDEBAR DESKTOP */}
                    <aside className="hidden md:flex w-20 flex-col items-center py-6 bg-[#0f1115] border-r border-[#1f2937] fixed h-full z-50">
                        <div className="mb-8 p-2 bg-[#E50914] rounded-lg shadow-lg shadow-red-900/40 cursor-pointer" onClick={() => {setActiveTab('home'); setSelectedItem(null); setIsLocked(false);}}>
                            <Icon name="play" size={24} fill="white" className="text-white"/>
                        </div>
                        <div className="flex flex-col gap-6 w-full">
                            {[
                                { id: 'home', icon: 'search', label: 'Inicio' },
                                { id: 'series', icon: 'film', label: 'Series' },
                                { id: 'movies', icon: 'clapperboard', label: 'Cine' },
                                { id: 'tv', icon: 'tv', label: 'TV' },
                                { id: 'favorites', icon: 'heart', label: 'Favs' }
                            ].map(tab => (
                                <button 
                                    key={tab.id}
                                    onClick={() => { setActiveTab(tab.id); setSelectedItem(null); setSearch(''); setIsLocked(false); }}
                                    className={`flex flex-col items-center gap-1 transition-colors ${activeTab === tab.id ? 'text-[#E50914]' : 'text-gray-500 hover:text-white'}`}
                                >
                                    <Icon name={tab.icon} size={24} fill={activeTab === tab.id && tab.id === 'favorites' ? 'currentColor' : 'none'} className={activeTab === tab.id && tab.id === 'favorites' ? 'fill-current' : ''} />
                                    <span className="text-[10px] font-medium">{tab.label}</span>
                                </button>
                            ))}
                        </div>
                        <div className="mt-auto mb-4 relative">
                            <div className="absolute -top-3 -right-2 text-lg transform rotate-12 z-20 pointer-events-none">üéÖ</div>
                            <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-yellow-400 to-yellow-600 flex items-center justify-center font-serif font-bold text-black border-2 border-white/20">J</div>
                        </div>
                    </aside>

                    {/* MOBILE HEADER */}
                    <div className="md:hidden fixed top-0 w-full bg-[#111827]/95 backdrop-blur z-50 px-4 py-3 flex items-center justify-between border-b border-[#1f2937]">
                        <div className="flex items-center gap-2 font-black text-xl tracking-tighter">
                            <span className="text-[#E50914]">STREAM</span>TUBE
                        </div>
                        <button onClick={() => setActiveTab('favorites')} className="relative">
                            <Icon name="heart" className={`${activeTab === 'favorites' ? 'text-[#E50914] fill-[#E50914]' : 'text-white'}`} fill={activeTab === 'favorites' ? '#E50914' : 'none'} />
                        </button>
                    </div>

                    {/* MOBILE NAV BOTTOM */}
                    <div className="md:hidden fixed bottom-0 w-full bg-[#0f1115] border-t border-[#1f2937] z-50 flex justify-around py-3 pb-safe">
                        {[
                            { id: 'home', icon: 'search', label: 'Inicio' },
                            { id: 'series', icon: 'film', label: 'Series' },
                            { id: 'movies', icon: 'clapperboard', label: 'Cine' },
                            { id: 'tv', icon: 'tv', label: 'TV' }
                        ].map(tab => (
                            <button 
                                key={tab.id}
                                onClick={() => { setActiveTab(tab.id); setSelectedItem(null); setIsLocked(false); }}
                                className={`flex flex-col items-center gap-1 ${activeTab === tab.id ? 'text-[#E50914]' : 'text-gray-500'}`}
                            >
                                <Icon name={tab.icon} size={22} />
                                <span className="text-[10px]">{tab.label}</span>
                            </button>
                        ))}
                    </div>

                    {/* MAIN CONTENT AREA */}
                    <main className="flex-1 md:ml-20 min-h-screen pt-16 md:pt-0 pb-20 md:pb-0 relative z-10">
                        
                        {/* L√ìGICA PRINCIPAL DE VISTAS */}
                        {(() => {
                            // 1. VISTA DE FAVORITOS (Si estamos en tab favoritos y no hay video seleccionado)
                            if (activeTab === 'favorites' && !selectedItem) {
                                const favTV = favorites.filter(i => i.type === 'tv');
                                const favOther = favorites.filter(i => i.type !== 'tv');
                                return (
                                    <div className="p-4 md:p-10 animate-fade-in">
                                        <div className="mb-6 flex items-center gap-3 border-b border-white/10 pb-4">
                                            <div className="p-2 bg-[#E50914]/20 rounded-lg text-[#E50914]">
                                                <Icon name="heart" size={24} fill="currentColor" />
                                            </div>
                                            <h2 className="text-2xl font-bold text-white">Estos son sus favoritos</h2>
                                        </div>
                                        {favTV.length > 0 && (
                                            <div className="mb-10">
                                                <h3 className="text-lg font-semibold text-gray-300 mb-4 pl-2 border-l-4 border-[#E50914]">Canales de TV</h3>
                                                <div className="bg-[#1f2937]/50 rounded-xl overflow-hidden border border-white/5">
                                                    {favTV.map(item => (
                                                        <TvListItem key={item.id} channel={item} isActive={false} isFavorite={true} onToggleFavorite={toggleFavorite} onClick={handlePlay} />
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        {favOther.length > 0 && (
                                            <div>
                                                <h3 className="text-lg font-semibold text-gray-300 mb-4 pl-2 border-l-4 border-blue-500">Pel√≠culas y Series</h3>
                                                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-x-4 gap-y-8">
                                                    {favOther.map((item, i) => (
                                                        <Card key={i} item={item} onClick={handlePlay} isFavorite={true} onToggleFavorite={toggleFavorite} />
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        {favorites.length === 0 && (
                                            <div className="text-center py-20 text-gray-500 flex flex-col items-center">
                                                <Icon name="heart" size={48} className="mb-4 opacity-20"/>
                                                <p>A√∫n no tienes favoritos guardados.</p>
                                            </div>
                                        )}
                                    </div>
                                );
                            }

                            // 2. VISTA DE TV (Si estamos en tab TV o viendo un canal)
                            if (activeTab === 'tv' || (selectedItem && selectedItem.type === 'tv')) {
                                return (
                                    <div className="flex flex-col lg:flex-row h-full lg:h-screen lg:overflow-hidden">
                                        <div className={`flex-1 bg-black relative flex flex-col lg:h-full ${selectedItem && selectedItem.type === 'tv' ? '' : 'hidden lg:flex'}`}>
                                            {selectedItem && selectedItem.type === 'tv' ? (
                                                <>
                                                    <div className="relative aspect-video w-full bg-black lg:flex-1">
                                                        <button onClick={() => setSelectedItem(null)} className="absolute top-4 left-4 z-20 bg-black/50 p-2 rounded-full text-white lg:hidden">
                                                            <Icon name="arrowLeft" size={20} />
                                                        </button>
                                                        {isDriveLink ? (
                                                            <div className="iframe-container"><iframe src={playUrl} allow="autoplay; encrypted-media; fullscreen" allowFullScreen></iframe></div>
                                                        ) : (
                                                            <video ref={videoRef} className="w-full h-full" controls autoPlay playsInline />
                                                        )}
                                                    </div>
                                                    <div className="p-4 bg-[#1f2937] border-b border-white/10">
                                                        <h2 className="text-lg font-bold text-white">{selectedItem.title}</h2>
                                                        <p className="text-xs text-[#E50914] font-bold uppercase">En Vivo Ahora</p>
                                                    </div>
                                                </>
                                            ) : (
                                                <div className="flex items-center justify-center h-full text-gray-500">
                                                    <p>Selecciona un canal para ver</p>
                                                </div>
                                            )}
                                        </div>
                                        <div className="w-full lg:w-96 bg-[#111827] lg:border-l border-white/10 flex flex-col lg:h-full lg:overflow-hidden">
                                            <div className="p-4 sticky top-16 lg:top-0 bg-[#111827] z-20 border-b border-white/5">
                                                <div className="relative">
                                                    <input type="text" placeholder="Buscar canal..." className="w-full bg-[#1f2937] border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:border-[#E50914] outline-none pl-10" value={search} onChange={(e) => setSearch(e.target.value)}/>
                                                    <Icon name="search" size={18} className="absolute left-3 top-3 text-gray-400"/>
                                                </div>
                                            </div>
                                            <div className="p-2 space-y-1 lg:overflow-y-auto lg:h-full">
                                                {loading ? (
                                                    <div className="flex justify-center py-10"><div className="animate-spin rounded-full h-8 w-8 border-2 border-[#E50914] border-t-transparent"></div></div>
                                                ) : (
                                                    (activeTab === 'tv' ? content.tv : favorites.filter(f => f.type === 'tv')).filter(c => !search || c.title.toLowerCase().includes(search.toLowerCase())).map((channel) => (
                                                        <TvListItem key={channel.id} channel={channel} isActive={selectedItem?.id === channel.id} isFavorite={favorites.some(f => f.id === channel.id)} onToggleFavorite={toggleFavorite} onClick={handlePlay} />
                                                    ))
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            }

                            // 3. VISTA DE REPRODUCTOR NORMAL (Series/Pelis)
                            if (selectedItem) {
                                return (
                                    <div className="animate-fade-in">
                                        <div className="w-full bg-black relative aspect-video md:h-[70vh] flex items-center justify-center">
                                            <div className="absolute top-4 left-4 z-20">
                                                <button onClick={() => {setSelectedItem(null); setIsLocked(false);}} className="bg-black/50 hover:bg-[#E50914] text-white px-4 py-2 rounded-full backdrop-blur-md flex items-center gap-2 transition-colors border border-white/10">
                                                    <Icon name="arrowLeft" size={18} /> <span className="hidden md:inline">Volver</span>
                                                </button>
                                            </div>
                                            {isLocked ? (
                                                <LockScreen correctCode={selectedItem.codigo || selectedItem.password || selectedItem.pin} onUnlock={() => setIsLocked(false)} onCancel={() => {setSelectedItem(null); setIsLocked(false);}} />
                                            ) : (
                                                isDriveLink ? (
                                                    <div className="iframe-container">
                                                        <iframe src={playUrl} allow="autoplay; encrypted-media; fullscreen" allowFullScreen></iframe>
                                                        <a href={playUrl} target="_blank" rel="noopener noreferrer" className="absolute top-4 right-4 bg-black/70 text-white px-3 py-1 rounded-full text-xs flex items-center gap-1 hover:bg-[#E50914] z-50 border border-white/20"><Icon name="external" size={12} /> Abrir externo</a>
                                                    </div>
                                                ) : (
                                                    <video ref={videoRef} className="w-full h-full" controls autoPlay playsInline />
                                                )
                                            )}
                                            {selectedItem.type === 'series' && !selectedEpisode && !isLocked && (
                                                <div className="absolute inset-0 flex items-center justify-center bg-black/80 z-10">
                                                    <p className="text-gray-400 font-bold">Selecciona un episodio de la lista</p>
                                                </div>
                                            )}
                                        </div>
                                        {!isLocked && (
                                            <div className="p-6 max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
                                                <div className="lg:col-span-2">
                                                    <div className="flex items-start justify-between mb-4">
                                                        <div>
                                                            <h1 className="text-3xl font-bold text-white mb-2">{selectedItem.title || selectedItem.name}</h1>
                                                            <div className="flex items-center gap-3 text-sm text-gray-400">
                                                                <span className="bg-[#1f2937] px-2 py-0.5 rounded text-white">{selectedItem.type.toUpperCase()}</span>
                                                                {selectedItem.type === 'series' && selectedEpisode && <span className="text-[#E50914] font-medium">{selectedEpisode.title}</span>}
                                                            </div>
                                                        </div>
                                                        <button onClick={() => toggleFavorite(selectedItem)} className="p-3 bg-[#1f2937] rounded-full hover:bg-[#2d3748]">
                                                            <Icon name="heart" size={24} className={favorites.some(f => (f.id||f.title) === (selectedItem.id||selectedItem.title)) ? "text-[#E50914] fill-[#E50914]" : "text-gray-400"} fill={favorites.some(f => (f.id||f.title) === (selectedItem.id||selectedItem.title)) ? "#E50914" : "none"} />
                                                        </button>
                                                    </div>
                                                    <p className="text-gray-300 leading-relaxed mb-6">{selectedItem.description || selectedItem.plot || "Sin descripci√≥n disponible."}</p>
                                                </div>
                                                <div className="bg-[#1f2937] rounded-xl p-4 h-fit border border-white/5">
                                                    {selectedItem.type === 'series' ? (
                                                        <div className="flex flex-col gap-2">
                                                            <h3 className="font-bold text-lg mb-2 flex items-center gap-2"><Icon name="film" size={18} className="text-[#E50914]"/> Temporadas</h3>
                                                            {selectedItem.seasons.map((season, idx) => (
                                                                <div key={idx} className="border-b border-gray-700 last:border-0 pb-2">
                                                                    <button type="button" onClick={() => setExpandedSeason(expandedSeason === idx ? null : idx)} className="w-full flex justify-between items-center py-2 text-sm font-bold hover:text-[#E50914]">
                                                                        <span>Temporada {season.season_number}</span>
                                                                        {expandedSeason === idx ? <Icon name="chevronUp" size={16}/> : <Icon name="chevronDown" size={16}/>}
                                                                    </button>
                                                                    {expandedSeason === idx && (
                                                                        <div className="flex flex-col gap-1 mt-1 pl-2">
                                                                            {season.episodes.length === 0 && <p className="text-xs text-gray-500 p-2">No hay episodios disponibles.</p>}
                                                                            {season.episodes.map((ep, eIdx) => (
                                                                                <div key={eIdx} onClick={() => { setSelectedEpisode(ep); window.scrollTo({top:0, behavior:'smooth'}); }} className={`text-sm p-2 rounded cursor-pointer truncate flex items-center gap-2 ${selectedEpisode?.url === ep.url ? 'bg-[#E50914] text-white' : 'text-gray-400 hover:bg-gray-700'}`}>
                                                                                    <Icon name="play" size={12} fill="currentColor" className="flex-shrink-0" /> {eIdx + 1}. {ep.title}
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <div>
                                                            <h3 className="font-bold mb-4 text-gray-200">Recomendados</h3>
                                                            <div className="flex flex-col gap-3">
                                                                {content[selectedItem.type === 'tv' ? 'tv' : 'movies'].slice(0, 5).map(rel => (
                                                                    <div key={rel.id || rel.title} onClick={() => handlePlay(rel)} className="flex gap-3 cursor-pointer group">
                                                                        <img src={rel.image || rel.poster} className="w-20 h-12 object-cover rounded bg-gray-800" />
                                                                        <div className="flex flex-col justify-center">
                                                                            <h4 className="text-sm font-bold line-clamp-1 group-hover:text-[#E50914]">{rel.title}</h4>
                                                                            <span className="text-xs text-gray-500">Ver ahora</span>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            }

                            // 4. VISTA POR DEFECTO (HOME/GRID)
                            return (
                                <>
                                    {activeTab === 'home' && <Snow />}
                                    <div className="sticky top-0 z-40 bg-[#111827]/95 backdrop-blur py-4 px-6 md:px-10 flex items-center justify-between border-b border-[#1f2937]">
                                        <div className="flex bg-[#1f2937] border border-[#374151] rounded-full px-4 py-2 w-full max-w-lg items-center focus-within:border-[#E50914] transition-colors">
                                            <Icon name="search" className="text-gray-400 w-5 h-5 mr-3" />
                                            <input type="text" placeholder={`Buscar en ${activeTab === 'home' ? 'todo' : activeTab}...`} className="bg-transparent w-full outline-none text-sm placeholder-gray-500 text-white" value={search} onChange={(e) => setSearch(e.target.value)}/>
                                        </div>
                                        <div className="hidden md:flex items-center gap-4 ml-4">
                                            <span className="text-xs font-bold text-gray-500 uppercase tracking-widest">{activeTab}</span>
                                        </div>
                                    </div>

                                    {/* --- AVISO SMART VIEW --- */}
                                    {activeTab === 'home' && !search && (
                                        <div className="mx-4 md:mx-10 mt-6 p-4 rounded-xl bg-gradient-to-r from-blue-900/40 to-[#111827] border border-blue-500/30 flex items-center gap-4 animate-fade-in">
                                            <div className="hidden md:flex p-3 bg-blue-600/20 rounded-full text-blue-400 shadow-[0_0_15px_rgba(59,130,246,0.3)]">
                                                <Icon name="tv" size={24} />
                                            </div>
                                            <div className="flex-1">
                                                <h3 className="text-white font-bold text-lg flex items-center gap-2">
                                                    <span className="md:hidden text-blue-400"><Icon name="tv" size={20}/></span>
                                                    Disfr√∫talo en tu Smart TV
                                                </h3>
                                                <p className="text-gray-300 text-sm mt-1">
                                                    Usa la funci√≥n <strong className="text-blue-400">Smart View</strong> (o "Transmitir") de tu m√≥vil para conectar y ver el contenido en tu televisor.
                                                </p>
                                            </div>
                                        </div>
                                    )}

                                    {activeTab === 'home' && !search && heroItem && <HeroSection item={heroItem} onPlay={handlePlay} isFavorite={favorites.some(f=>(f.id||f.title)===(heroItem.id||heroItem.title))} onToggleFavorite={toggleFavorite}/>}
                                    <div className="p-4 md:p-10">
                                        {activeTab === 'home' && !search && (
                                            <div className="mb-8 flex items-center gap-2">
                                                <div className="w-1 h-6 bg-[#E50914] rounded-full"></div>
                                                <h2 className="text-xl font-bold">Tendencias Recientes</h2>
                                            </div>
                                        )}
                                        {loading ? (
                                            <div className="flex justify-center py-20"><div className="animate-spin rounded-full h-12 w-12 border-4 border-[#E50914] border-t-transparent"></div></div>
                                        ) : displayedItems.length === 0 ? (
                                            <div className="text-center py-20 text-gray-500 flex flex-col items-center">
                                                <Icon name="alertCircle" size={48} className="mb-4 opacity-50"/>
                                                <p>No hay contenido disponible en esta secci√≥n.</p>
                                            </div>
                                        ) : (
                                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-x-4 gap-y-8 animate-slide-up">
                                                {displayedItems.map((item, i) => (
                                                    <Card key={i} item={item} onClick={handlePlay} isFavorite={favorites.some(f => (f.id||f.title) === (item.id||item.title))} onToggleFavorite={toggleFavorite}/>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </>
                            );
                        })()}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
